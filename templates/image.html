<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head
          content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="Dr. Dmitry A. Duev">

    <title>Robo-AO status images</title>

    <!-- Bootstrap core CSS -->
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap theme -->
    <link href="/static/css/bootstrap-theme.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="/static/theme.css" rel="stylesheet">

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/static/robot-favicon.png" />

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <script src="http://code.jquery.com/jquery-2.0.3.min.js"></script>

    <script src="/static/js/bootstrap.min.js"></script>
    <!--
    <script src="//oss.maxcdn.com/bootbox/4.4.0/bootbox.min.js"></script>
    -->

    <script>
        // show/hide box
        function showHideBox() {

            if ($("#bx").css('display') != "none") {
                $("#bx").fadeOut();
            }
            else {
                $("#bx").fadeIn();
            }
        }

        var vicd_toggle = true;
        function canvas_vicd_click() {
            // show field center:
            showHideBox();
            // show IR camera box
//            vicd_toggle = (vicd_toggle == true) ? false : true;
            vicd_toggle = (vicd_toggle != true);
        }
    </script>

    <!-- WS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.slim.js"></script>
    <script>

        $(document).ready(function() {
            var ctx_dm = document.getElementById('canvas-dm').getContext('2d');
            ctx_dm.imageSmoothingEnabled = false;
            ctx_dm.webkitImageSmoothingEnabled = false;
            ctx_dm.msImageSmoothingEnabled = false;
            ctx_dm.mozImageSmoothingEnabled = false;

            var ctx_wfs = document.getElementById('canvas-wfs').getContext('2d');
            ctx_wfs.imageSmoothingEnabled = false;
            ctx_wfs.mozImageSmoothingEnabled = false;
            ctx_wfs.webkitImageSmoothingEnabled = false;
            ctx_wfs.msImageSmoothingEnabled = false;
            // flip vertically (as the png is somehow flipped):
            //ctx_wfs.translate(0, 300);
            //ctx_wfs.scale(1, -1);

            var ctx_vicd = document.getElementById('canvas-vicd').getContext('2d');
            ctx_vicd.imageSmoothingEnabled = false;
            ctx_vicd.mozImageSmoothingEnabled = false;
            ctx_vicd.webkitImageSmoothingEnabled = false;
            ctx_vicd.msImageSmoothingEnabled = false;

            var socket = io();

            // init canvases:
            var img_dm = new Image();
            var img_wfs = new Image();
            var img_vicd = new Image();

            img_vicd.onload = function() {
                // Clear canvas and immediately paint the image
                ctx_vicd.drawingContext.clearRect(0, 0, 300, 300);
                ctx_vicd.drawingContext.drawImage(img_vicd, 0, 0);
            };

            // init pointing helpers for vicd
            var VIC_width = ctx_vicd.canvas.clientWidth;  // this is 36 arcsec
            var VIC_height = ctx_vicd.canvas.clientHeight;  // this is 36 arcsec

            var IRC_width = 20 * VIC_width / 36;
            var IRC_height = 16 * VIC_height / 36;

            // before alignment in March 2017
            //var IRC_offset_x = 0.94 * VIC_width / 36;
            //var IRC_offset_y = 2.19 * VIC_height / 36;
            // after alignment:
            var IRC_offset_x = 0;
            var IRC_offset_y = 0;

            // dither center positions for IR camera:
            var IRC_offset_dither_1_x = -5 * VIC_width / 36;
            var IRC_offset_dither_1_y = 0;
            var IRC_offset_dither_2_x = 5 * VIC_width / 36;
            var IRC_offset_dither_2_y = 0;
            // console.log(VIC_width, ' ', VIC_height, ' ', IRC_width, ' ', IRC_height, ' ');

            socket.on('dm', function (info) {
                if (info.image) {
                    var uint8Arr = new Uint8Array(info.buffer);
                    var binary = '';
                    for (var i = 0; i < uint8Arr.length; i++) {
                        binary += String.fromCharCode(uint8Arr[i]);
                    }
                    var base64String = window.btoa(binary);

                    img_dm.src = 'data:image/png;base64,' + base64String;
//                    img_dm.src = 'data:image/jpg;base64,' + info.buffer;
//                    ctx_dm.clearRect(0, 0, 300, 300);
                    ctx_dm.drawImage(img_dm, 0, 0, 300, 300);
                }
            });

            socket.on('wfs', function (info) {
                if (info.image) {
                    var uint8Arr = new Uint8Array(info.buffer);
                    var binary = '';
                    for (var i = 0; i < uint8Arr.length; i++) {
                        binary += String.fromCharCode(uint8Arr[i]);
                    }
                    var base64String = window.btoa(binary);

                    img_wfs.src = 'data:image/png;base64,' + base64String;
//                    img_wfs.src = 'data:image/jpeg;base64,' + info.buffer;
//                    ctx_wfs.clearRect(0, 0, 300, 300);
                    ctx_wfs.drawImage(img_wfs, 0, 0, 300, 300);
                }
            });

            socket.on('vicd', function (info) {
                if (info.image) {
                    var uint8Arr = new Uint8Array(info.buffer);
                    var binary = '';
                    for (var i = 0; i < uint8Arr.length; i++) {
                        binary += String.fromCharCode(uint8Arr[i]);
                    }
                    var base64String = window.btoa(binary);

                    img_vicd.src = 'data:image/png;base64,' + base64String;
//                    img_vicd.src = 'data:image/jpeg;base64,' + info.buffer;
//                    ctx_vicd.clearRect(0, 0, VIC_width, VIC_height);
//                    ctx_vicd.drawImage(img_vicd, 0, 0, VIC_width, VIC_height);
//                    ctx_vicd.drawImage(img_vicd, 0, 0, 300, 300);
                    console.log(base64String.substring(0,100));
                    if (vicd_toggle && false) {
                        // IR camera box
                        ctx_vicd.beginPath();
                        ctx_vicd.strokeStyle = "#ffffff";
                        ctx_vicd.lineWidth = 1;
                        var start_rect_x = (VIC_width - IRC_width)/2 + IRC_offset_x;
                        var start_rect_y = (VIC_height - IRC_height)/2 - IRC_offset_y;
                        ctx_vicd.rect(start_rect_x, start_rect_y, IRC_width, IRC_height);
                        ctx_vicd.stroke();
                        ctx_vicd.closePath();
                        // pointing circle for VIC
                        var radius_vic = VIC_width / 36; // 1" in pix
                        ctx_vicd.beginPath();
                        ctx_vicd.strokeStyle = '#BADA55';
                        ctx_vicd.lineWidth = 2;
                        ctx_vicd.arc(VIC_width/2, VIC_height/2, radius_vic, 0, 2 * Math.PI, false);
                        ctx_vicd.stroke();
                        ctx_vicd.closePath();
                        // pointing circle for IRC
                        if (Math.abs(IRC_offset_x) > 0 && Math.abs(IRC_offset_y) > 0) {
                            var radius_ir = VIC_width / 36; // 1" in pix
                            ctx_vicd.beginPath();
                            ctx_vicd.strokeStyle = '#ff6445';
                            ctx_vicd.lineWidth = 2;
                            ctx_vicd.arc(VIC_width / 2 + IRC_offset_x, VIC_height / 2 - IRC_offset_y,
                                radius_ir, 0, 2 * Math.PI, false);
                            ctx_vicd.stroke();
                            ctx_vicd.closePath();
                        }
                        // dither centers:
                        var radius_ir_dither = VIC_width / 36 / 4; // 0.25" in pix
                        // first center
                        ctx_vicd.beginPath();
                        ctx_vicd.strokeStyle = '#ff6445';
                        ctx_vicd.lineWidth = 1;
                        ctx_vicd.arc(VIC_width / 2 + IRC_offset_x + IRC_offset_dither_1_x,
                            VIC_height / 2 - IRC_offset_y + IRC_offset_dither_1_y,
                            radius_ir_dither, 0, 2 * Math.PI, false);
                        ctx_vicd.stroke();
                        ctx_vicd.closePath();
                        // second center
                        ctx_vicd.beginPath();
                        ctx_vicd.strokeStyle = '#ff6445';
                        ctx_vicd.lineWidth = 1;
                        ctx_vicd.arc(VIC_width / 2 + IRC_offset_x + IRC_offset_dither_2_x,
                            VIC_height / 2 - IRC_offset_y + IRC_offset_dither_2_y,
                            radius_ir_dither, 0, 2 * Math.PI, false);
                        ctx_vicd.stroke();
                        ctx_vicd.closePath();
                    }
                }
            });

        });
    </script>

    <style>
        @media only screen and (min-width: 930px) {
            /* wide screen: */
            #img-outer {
                width: 100%;
                text-align: center;
                margin: 0 auto;
            }
            #img-inner {
                width: 900px;
                display: inline-block;
                margin: 0;
                padding: 0;
            }
            #canvas-dm {
                position:relative;
                left:-300px;
                margin: 0;
                padding: 0;
            }
            #canvas-wfs {
                transform: scaleY(-1);
                display: block;
                position: relative;
                top: -3px;
                margin: 0;
                padding: 0;
            }
            #canvas-vicd {
                position: relative;
                right:-152px;
                height: 600px;
                top: -13px;
                margin-top:-600px;
            }
        }
        @media only screen and (max-width: 930px) {
            /* narrow screen: */
            #img-outer {
                width: 100%;
                text-align: center;
                margin: 0 auto;
            }
            #img-inner {
                width: 600px;
                height: 950px;
                display: inline-block;
                margin: 0;
                padding: 0;
            }
            #canvas-dm {
                position:relative;
                left:-150px;
                margin: 0;
                padding: 0;
            }
            #canvas-wfs {
                transform: scaleY(-1);
                display: block;
                position: relative;
                top: -303px;
                left: 300px;
                margin: 0;
                padding: 0;
            }
            #canvas-vicd {
                position: relative;
                right:0px;
                height: 600px;
                top: 290px;
                margin-top:-600px;
            }
        }


    </style>

</head>

<!-- Fixed navbar -->
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed"
                    data-toggle="collapse" data-target="#navbar"
                    aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Robo-AO</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li><a href="/">Status</a></li>
                <li class="active"><a href="#">Images</a></li>
                <li><a href="http://www.oir.caltech.edu/twiki_oir/bin/viewauth/Palomar/RoboAO/WebHome">Twiki</a></li>
            </ul>
        </div>
    </div>
</nav>

<body role="document">



<div class="container" role="main">

    <div class="row">

        <div class="col-md-12">

            <div class="page-header" style="margin-top:-30px;">
                <h3>Robo-AO images</h3>
            </div>

            <div id="img-outer">
                <div id="img-inner">
                    <canvas id="canvas-dm" width="300px" height="300px"></canvas>
                    <canvas id="canvas-wfs" width="300px" height="300px"></canvas>
                    <canvas id="canvas-vicd" width="600px" height="600px" onclick="canvas_vicd_click()"></canvas>
                    <div class="box" id="bx"></div>
                </div>

            </div>
            <br><br>
        </div>
    </div>
</div>

</body>

</html>
